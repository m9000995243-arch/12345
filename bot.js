javascript
const { Telegraf, Markup } = require('telegraf');
const axios = require('axios');
const express = require('express');

const app = express();
const PORT = process.env.PORT || 3000;

// ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
// –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô –¢–û–ö–ï–ù –û–¢ BOTFATHER
const TELEGRAM_BOT_TOKEN = "8125387296:AAHK5-dz0x84jUyu5NpqQM65RQrw6tX5E";

// –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô –¢–û–ö–ï–ù –û–¢ HUGGING FACE
const HUGGING_FACE_TOKEN = "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";

// –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô ID –ò–ó @userinfobot (–¢–û–õ–¨–ö–û –¶–ò–§–†–´)
const ADMIN_CHAT_ID = 1210191057; // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô ID

const bot = new Telegraf(TELEGRAM_BOT_TOKEN);

// ===== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–í–û–Å–ú –ë–†–ï–ù–î–ï =====
const BRAND_INFO = `
–¢—ã - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–µ–Ω–¥–∞ "Mortem Vellum".
–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∞—à–µ–π –ø—Ä–æ–¥—É–∫—Ü–∏–µ–π –∏ —É—Å–ª—É–≥–∞–º–∏.
–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ, –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∂–∏—Å—å –æ—Ç–≤–µ—á–∞—Ç—å.

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ë–†–ï–ù–î–ï:

- –ú—ã –ø—Ä–æ–¥–∞—ë–º –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—É—é –∏ –º–æ–¥–Ω—É—é –æ–¥–µ–∂–¥—É —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–∑–¥–∞–Ω–∏—è
- –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –†–æ—Å—Å–∏–∏ —Ç–∞–∫–∏–º–∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏ –∫–∞–∫ –°–î–ï–ö/–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏/Boxberry/Avito –î–æ—Å—Ç–∞–≤–∫–∞/
- –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∫–∏: +7 900 099 52 43
- –ú—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –æ–¥–µ–∂–¥—É –≤—Ä—É—á–Ω—É—é. –ø—Ä–∏–Ω—Ç—ã –Ω–∞–Ω–æ—Å–∏–º —Å –ø–æ–º–æ—â—å—é —à–µ–ª–∫–æ–≥—Ä–∞—Ñ–∏–∏.
- –î–æ—Å—Ç–∞–≤–∫–∞ –≤–æ –≤—Å–µ —Ä–µ–≥–∏–æ–Ω—ã –†–æ—Å—Å–∏–∏
- –ì–∞—Ä–∞–Ω—Ç–∏—è 7 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.(—Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –±—Ä–∞–∫. –ø–æ—Ä–≤–∞–Ω–Ω–∞—è –≤–µ—â—å –ø–æ –Ω–µ–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –Ω–µ–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ–π)
- –í–æ–∑–≤—Ä–∞—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –∑–∞ –Ω–∞—à —Å—á–µ—Ç, –µ—Å–ª–∏ –≤–µ—â—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ –Ω–∞—à–µ–π –æ—à–∏–±–∫–µ.
- –û–±–º–µ–Ω –∏–¥–µ—è–º–∏: –ø—Ä–∏—à–ª–∏ —Å–≤–æ—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é - –ø–æ–ª—É—á–∏ —Å–∫–∏–¥–∫—É 20%
–≤ —Å–ª—É—á–∞–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–µ–¥–æ–ø–æ–Ω–∏–º–∞–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º, –ø–æ–ø—Ä–æ—Å–∏ –µ–≥–æ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ–∑–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
- –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤ –¥–µ–Ω—å –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞ –ª–∏–±–æ –ø–æ 50 –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–π –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ –∏ –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–æ–º –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –∫–ª–∏–µ–Ω—Ç –æ–±—è–∑–∞–Ω –±—É–¥–µ—Ç –æ–ø–ª–∞—Ç–∏—Ç—å.

–ü–æ–º–Ω–∏: —Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–π –±—Ä–µ–Ω–¥, –±—É–¥—å –≤–µ–∂–ª–∏–≤, –∫—Ä–∞—Ç–æ–∫ –∏ –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª–µ–Ω –≤ –æ—Ç–≤–µ—Ç–∞—Ö.
`;

// –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π
const keyboard = Markup.keyboard([
  ['üë®‚Äçüíº –ü–æ–∑–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞']
]).resize();

// ===== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–ü–†–û–°–ê –ö –ë–ï–°–ü–õ–ê–¢–ù–û–ô –ù–ï–ô–†–û–°–ï–¢–ò =====
async function askAI(question) {
  try {
    const API_URL = "https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium";
    const headers = { 
      "Authorization": `Bearer ${HUGGING_FACE_TOKEN}` 
    };

    // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
    const context = `${BRAND_INFO}\n\n–í–æ–ø—Ä–æ—Å: ${question}\n–û—Ç–≤–µ—Ç:`;
    
    const payload = {
      "inputs": context,
      "parameters": {
        "max_length": 250,
        "temperature": 0.7,
        "do_sample": true
      }
    };
    
    const response = await axios.post(API_URL, payload, { headers });
    
    if (response.status === 200) {
      const result = response.data;
      if (Array.isArray(result) && result.length > 0) {
        let answer = result[0].generated_text || '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Å–µ–π—á–∞—Å.';
        
        // –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—à–Ω–µ–≥–æ
        if (answer.includes('–û—Ç–≤–µ—Ç:')) {
          answer = answer.split('–û—Ç–≤–µ—Ç:')[1]?.trim() || answer;
        }
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
        return answer.slice(0, 400);
      }
    }
    return "–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '–ü–æ–∑–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'.";
    
  } catch (error) {
    console.log('–û—à–∏–±–∫–∞ AI:', error.message);
    return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ '–ü–æ–∑–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞' –¥–ª—è —Å–≤—è–∑–∏ —Å —á–µ–ª–æ–≤–µ–∫–æ–º.";
  }
}

// ===== –•–†–ê–ù–ò–õ–ò–©–ï –ò–°–¢–û–†–ò–ò –ß–ê–¢–û–í =====
const userHistory = new Map();

// ===== –ö–û–ú–ê–ù–î–ê /start =====
bot.start((ctx) => {
  const userId = ctx.from.id;
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  userHistory.set(userId, []);
  
  ctx.reply(
    '–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ –Ω–∞—à–µ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å. ' +
    '–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å –∂–∏–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.',
    keyboard
  );
});

// ===== –û–ë–†–ê–ë–û–¢–ö–ê –û–ë–´–ß–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô =====
bot.on('text', async (ctx) => {
  const userText = ctx.message.text;
  const userId = ctx.from.id;
  const userName = ctx.from.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–ü–æ–∑–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"
  if (userText === 'üë®‚Äçüíº –ü–æ–∑–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞') {
    // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
    const history = userHistory.get(userId) || [];
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    let historyText = "–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞";
    if (history.length > 0) {
      historyText = history.map((chat, index) => 
        `–°–æ–æ–±—â–µ–Ω–∏–µ ${index + 1}:\n–í–æ–ø—Ä–æ—Å: ${chat.question}\n–û—Ç–≤–µ—Ç: ${chat.answer}`
      ).join('\n\n');
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞
    const adminMessage = 
`üîî –°–û–¢–†–£–î–ù–ò–ö–ê –ó–û–í–£–¢!

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName}
üÜî ID: ${userId}

üìã –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞:
${historyText}

üí¨ –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${userText}"`;

    try {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
      await bot.telegram.sendMessage(ADMIN_CHAT_ID, adminMessage);
      
      // –ì–æ–≤–æ—Ä–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      await ctx.reply('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–∂–µ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏! –û–∂–∏–¥–∞–π—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.', keyboard);
      
      // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞
      userHistory.set(userId, []);
      
    } catch (error) {
      await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞ support@mybrand.ru', keyboard);
    }
    return;
  }

  // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ AI
  try {
    console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —Å–ø—Ä–æ—Å–∏–ª: ${userText}`);
    
    // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI
    const aiResponse = await askAI(userText);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    if (!userHistory.has(userId)) {
      userHistory.set(userId, []);
    }
    
    const history = userHistory.get(userId);
    history.push({
      question: userText,
      answer: aiResponse
    });
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π)
    if (history.length > 10) {
      history.shift();
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await ctx.reply(aiResponse, keyboard);
    
  } catch (error) {
    console.log('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
    await ctx.reply(
      '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞ support@mybrand.ru –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–∑–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞".',
      keyboard
    );
  }
});

// ===== –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –ë–û–¢–ê =====
bot.catch((error, ctx) => {
  console.log('–û—à–∏–±–∫–∞ –±–æ—Ç–∞:', error);
});

// ===== –ó–ê–ü–£–°–ö –ë–û–¢–ê =====
bot.launch().then(() => {
  console.log('ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!');
}).catch((error) => {
  console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', error.message);
});

// ===== EXPRESS –°–ï–†–í–ï–† –î–õ–Ø RENDER =====
app.get('/', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
        <title>Telegram Bot</title>
        <style>
            body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
            h1 { color: #0088cc; }
        </style>
    </head>
    <body>
        <h1>‚úÖ Telegram Bot is running!</h1>
        <p>ü§ñ –ë–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</p>
        <p>‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}</p>
    </body>
    </html>
  `);
});

// –ó–∞–ø—É—Å–∫–∞–µ–º Express —Å–µ—Ä–≤–µ—Ä
app.listen(PORT, () => {
  console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
});

// –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));

console.log('üîÑ –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...');